/*! ImageCropper 31-03-2015 */
var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Handle=function(){function a(a,b,c){this.over=!1,this.drag=!1,this.position=new Point(a,b),this.offset=new Point(0,0),this.radius=c}return a.prototype.setDrag=function(a){this.drag=a,this.over=a},a.prototype.draw=function(){},a.prototype.setOver=function(a){this.over=a},a.prototype.touchInBounds=function(a,b){return a>this.position.x-this.radius&&a<this.position.x+this.radius&&b>this.position.y-this.radius&&b<this.position.y+this.radius},a.prototype.getPosition=function(){return this.position},a.prototype.setPosition=function(a,b){this.position=new Point(a,b)},a}(),CropService=function(){function a(){}return a.init=function(a){this.canvas=a,this.ctx=this.canvas.getContext("2d")},a.DEG2RAD=.0174532925,a}(),DragMarker=function(a){function b(b,c,d){a.call(this,b,c,d)}return __extends(b,a),b.prototype.draw=function(a){var b=1;(this.over||this.drag)&&(b=1.2),this.drawConnector(a,90,b),this.drawConnector(a,0,b),this.drawArrow(a,0,b),this.drawArrow(a,90,b),this.drawArrow(a,180,b),this.drawArrow(a,270,b)},b.prototype.rotatePoint=function(a,b,c,d){var e=Math.sin(c),f=Math.cos(c);d.x-=a,d.y-=b;var g=d.x*f-d.y*e,h=d.x*e+d.y*f;return d.x=g+a,d.y=h+b,d},b.prototype.drawConnector=function(a,b,c){b*=CropService.DEG2RAD;var d=new Point(this.position.x,this.position.y),e=this.rotatePoint(d.x,d.y,b,new Point(this.position.x-2*c,this.position.y+9*c)),f=this.rotatePoint(d.x,d.y,b,new Point(this.position.x+2*c,this.position.y+9*c)),g=this.rotatePoint(d.x,d.y,b,new Point(this.position.x+2*c,this.position.y-9*c)),h=this.rotatePoint(d.x,d.y,b,new Point(this.position.x-2*c,this.position.y-9*c));a.beginPath(),a.moveTo(h.x,h.y),a.lineTo(e.x,e.y),a.lineTo(f.x,f.y),a.lineTo(g.x,g.y),a.lineTo(h.x,h.y),a.closePath(),a.fillStyle="rgba(255,228,0,1)",a.fill()},b.prototype.drawArrow=function(a,b,c){b*=CropService.DEG2RAD;var d=new Point(this.position.x,this.position.y),e=this.rotatePoint(d.x,d.y,b,new Point(this.position.x-5*c,this.position.y+8*c)),f=this.rotatePoint(d.x,d.y,b,new Point(this.position.x,this.position.y+15*c)),g=this.rotatePoint(d.x,d.y,b,new Point(this.position.x+5*c,this.position.y+8*c)),h=this.rotatePoint(d.x,d.y,b,new Point(this.position.x,this.position.y+8*c));a.beginPath(),a.moveTo(h.x,h.y),a.lineTo(e.x,e.y),a.lineTo(f.x,f.y),a.lineTo(g.x,g.y),a.lineTo(h.x,h.y),a.closePath(),a.fillStyle="rgba(255,228,0,1)",a.fill()},b.prototype.recalculatePosition=function(a){var b=a.getCentre();this.setPosition(b.x,b.y)},b}(Handle),CornerMarker=function(a){function b(b,c,d){a.call(this,b,c,d)}return __extends(b,a),b.prototype.drawCornerBorder=function(a){var b=10;(this.over||this.drag)&&(b=12);var c=1,d=1;this.horizontalNeighbour.position.x<this.position.x&&(c=-1),this.verticalNeighbour.position.y<this.position.y&&(d=-1),a.beginPath(),a.lineJoin="miter",a.moveTo(this.position.x,this.position.y),a.lineTo(this.position.x+b*c,this.position.y),a.lineTo(this.position.x+b*c,this.position.y+b*d),a.lineTo(this.position.x,this.position.y+b*d),a.lineTo(this.position.x,this.position.y),a.closePath(),a.lineWidth=2,a.strokeStyle="rgba(255,228,0,1)",a.stroke()},b.prototype.drawCornerFill=function(a){var b=10;(this.over||this.drag)&&(b=12);var c=1,d=1;this.horizontalNeighbour.position.x<this.position.x&&(c=-1),this.verticalNeighbour.position.y<this.position.y&&(d=-1),a.beginPath(),a.moveTo(this.position.x,this.position.y),a.lineTo(this.position.x+b*c,this.position.y),a.lineTo(this.position.x+b*c,this.position.y+b*d),a.lineTo(this.position.x,this.position.y+b*d),a.lineTo(this.position.x,this.position.y),a.closePath(),a.fillStyle="rgba(0,0,0,1)",a.fill()},b.prototype.moveX=function(a){this.setPosition(a,this.position.y)},b.prototype.moveY=function(a){this.setPosition(this.position.x,a)},b.prototype.move=function(a,b){this.setPosition(a,b),this.verticalNeighbour.moveX(a),this.horizontalNeighbour.moveY(b)},b.prototype.addHorizontalNeighbour=function(a){this.horizontalNeighbour=a},b.prototype.addVerticalNeighbour=function(a){this.verticalNeighbour=a},b.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},b.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},b.prototype.draw=function(a){this.drawCornerFill(a),this.drawCornerBorder(a)},b}(Handle),Bounds=function(){function a(a,b,c,d){void 0===a&&(a=0),void 0===b&&(b=0),void 0===c&&(c=0),void 0===d&&(d=0),this.left=a,this.right=a+c,this.top=b,this.bottom=b+d}return a.prototype.getWidth=function(){return this.right-this.left},a.prototype.getHeight=function(){return this.bottom-this.top},a.prototype.getCentre=function(){var a=this.getWidth(),b=this.getHeight();return new Point(this.left+a/2,this.top+b/2)},a}(),Point=function(){function a(a,b){void 0===a&&(a=0),void 0===b&&(b=0),this.x=a,this.y=b}return a}(),ImageCropper=function(){function a(a,b,c,d,e,f,g){void 0===b&&(b=0),void 0===c&&(c=0),void 0===d&&(d=100),void 0===e&&(e=50),void 0===f&&(f=!0),void 0===g&&(g=20),this.keepAspect=!1,this.aspectRatio=0,this.handle=null,this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="png",this.imageSet=!1,CropService.init(a),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.buffer.width=a.width,this.buffer.height=a.height,this.tl=new CornerMarker(b,c,g),this.tr=new CornerMarker(b+d,c,g),this.bl=new CornerMarker(b,c+e,g),this.br=new CornerMarker(b+d,c+e,g),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new DragMarker(b+d/2,c+e/2,g),this.canvas=a,this.ctx=this.canvas.getContext("2d"),this.keepAspect=f,this.aspectRatio=e/d,this.draw(this.ctx),this.croppedImage=new Image,window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),a.addEventListener("mousedown",this.onMouseDown.bind(this))}return a.prototype.resizeCanvas=function(a,b){this.canvas.width=a,this.canvas.height=b,this.buffer.width=a,this.buffer.height=b,this.draw(this.ctx)},a.prototype.draw=function(a){var b=this.getBounds();if(this.srcImage){a.clearRect(0,0,this.canvas.width,this.canvas.height);var c=this.srcImage.height/this.srcImage.width,d=this.canvas.height/this.canvas.width,e=this.canvas.width,f=this.canvas.height;d>c?(e=this.canvas.width,f=this.canvas.width*c):(f=this.canvas.height,e=this.canvas.height/c),this.ratioW=e/this.srcImage.width,this.ratioH=f/this.srcImage.height,c>d?a.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-e/2,0,e,f):a.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-f/2,e,f),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height),a.clearRect(0,0,this.canvas.width,this.canvas.height),c>d?a.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-e/2,0,e,f):a.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-f/2,e,f),a.fillStyle="rgba(0, 0, 0, 0.7)",a.fillRect(0,0,this.canvas.width,this.canvas.height),a.drawImage(this.buffer,b.left,b.top,Math.max(b.getWidth(),1),Math.max(b.getHeight(),1),b.left,b.top,b.getWidth(),b.getHeight());for(var g,h=0;h<this.markers.length;h++)g=this.markers[h],g.draw(a);this.center.draw(a),a.lineWidth=2,a.strokeStyle="rgba(255,228,0,1)",a.strokeRect(b.left,b.top,b.getWidth(),b.getHeight())}else a.fillStyle="rgba(192,192,192,1)",a.fillRect(0,0,this.canvas.width,this.canvas.height)},a.prototype.dragCrop=function(a,b,c){var d=this.getBounds(),e=a-d.getWidth()/2,f=a+d.getWidth()/2,g=b-d.getHeight()/2,h=b+d.getHeight()/2;f>=this.maxXClamp&&(a=this.maxXClamp-d.getWidth()/2),e<=this.minXClamp&&(a=d.getWidth()/2+this.minXClamp),g<this.minYClamp&&(b=d.getHeight()/2+this.minYClamp),h>=this.maxYClamp&&(b=this.maxYClamp-d.getHeight()/2),this.tl.moveX(a-d.getWidth()/2),this.tl.moveY(b-d.getHeight()/2),this.tr.moveX(a+d.getWidth()/2),this.tr.moveY(b-d.getHeight()/2),this.bl.moveX(a-d.getWidth()/2),this.bl.moveY(b+d.getHeight()/2),this.br.moveX(a+d.getWidth()/2),this.br.moveY(b+d.getHeight()/2),c.setPosition(a,b)},a.prototype.dragCorner=function(a,b,c){var d,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0;this.keepAspect?(d=c.getHorizontalNeighbour().getVerticalNeighbour(),g=d.getPosition().x,h=d.getPosition().y,a<=d.getPosition().x?b<=d.getPosition().y?(e=g-100/this.aspectRatio,f=h-100/this.aspectRatio*this.aspectRatio,m=this.getSide(new Point(e,f),d.getPosition(),new Point(a,b)),m>0?(i=Math.abs(d.getPosition().y-b),j=i/this.aspectRatio,k=d.getPosition().y-i,l=d.getPosition().x-j,c.move(l,k)):0>m&&(j=Math.abs(d.getPosition().x-a),i=j*this.aspectRatio,k=d.getPosition().y-i,l=d.getPosition().x-j,c.move(l,k))):(e=g-100/this.aspectRatio,f=h+100/this.aspectRatio*this.aspectRatio,m=this.getSide(new Point(e,f),d.getPosition(),new Point(a,b)),m>0?(j=Math.abs(d.getPosition().x-a),i=j*this.aspectRatio,k=d.getPosition().y+i,l=d.getPosition().x-j,c.move(l,k)):0>m&&(i=Math.abs(d.getPosition().y-b),j=i/this.aspectRatio,k=d.getPosition().y+i,l=d.getPosition().x-j,c.move(l,k))):b<=d.getPosition().y?(e=g+100/this.aspectRatio,f=h-100/this.aspectRatio*this.aspectRatio,m=this.getSide(new Point(e,f),d.getPosition(),new Point(a,b)),0>m?(i=Math.abs(d.getPosition().y-b),j=i/this.aspectRatio,k=d.getPosition().y-i,l=d.getPosition().x+j,c.move(l,k)):m>0&&(j=Math.abs(d.getPosition().x-a),i=j*this.aspectRatio,k=d.getPosition().y-i,l=d.getPosition().x+j,c.move(l,k))):(e=g+100/this.aspectRatio,f=h+100/this.aspectRatio*this.aspectRatio,m=this.getSide(new Point(e,f),d.getPosition(),new Point(a,b)),0>m?(j=Math.abs(d.getPosition().x-a),i=j*this.aspectRatio,k=d.getPosition().y+i,l=d.getPosition().x+j,c.move(l,k)):m>0&&(i=Math.abs(d.getPosition().y-b),j=i/this.aspectRatio,k=d.getPosition().y+i,l=d.getPosition().x+j,c.move(l,k)))):c.move(a,b),this.center.recalculatePosition(this.getBounds())},a.prototype.getSide=function(a,b,c){return this.sign((b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x))},a.prototype.sign=function(a){return+a===a?0===a?a:a>0?1:-1:0/0},a.prototype.handleRelease=function(){this.handle&&this.handle.setDrag(!1),this.handle=null},a.prototype.handleMove=function(a,b){if(null!=this.handle){var c=this.clampPosition(a-this.handle.offset.x,b-this.handle.offset.y);a=c.x,b=c.y,this.handle instanceof CornerMarker?this.dragCorner(a,b,this.handle):this.dragCrop(a,b,this.handle)}else{for(var d=0;d<this.markers.length;d++){var e=this.markers[d];if(e.touchInBounds(a,b)){this.handle=e,e.setDrag(!0),this.handle.offset.x=a-this.handle.position.x,this.handle.offset.y=b-this.handle.position.y,this.dragCorner(a-this.handle.offset.x,b-this.handle.offset.y,this.handle);break}}null==this.handle&&this.center.touchInBounds(a,b)&&(this.handle=this.center,this.handle.setDrag(!0),this.handle.offset.x=a-this.handle.position.x,this.handle.offset.y=b-this.handle.position.y,this.dragCrop(a-this.handle.offset.x,b-this.handle.offset.y,this.center))}},a.prototype.updateClampBounds=function(){var a=this.srcImage.height/this.srcImage.width,b=this.canvas.height/this.canvas.width,c=this.canvas.width,d=this.canvas.height;b>a?(c=this.canvas.width,d=this.canvas.width*a):(d=this.canvas.height,c=this.canvas.height/a),this.minXClamp=this.canvas.width/2-c/2,this.minYClamp=this.canvas.height/2-d/2,this.maxXClamp=this.canvas.width/2+c/2,this.maxYClamp=this.canvas.height/2+d/2},a.prototype.clampPosition=function(a,b){return a<this.minXClamp&&(a=this.minXClamp),a>this.maxXClamp&&(a=this.maxXClamp),b<this.minYClamp&&(b=this.minYClamp),b>this.maxYClamp&&(b=this.maxYClamp),new Point(a,b)},a.prototype.isImageSet=function(){return this.imageSet},a.prototype.setImage=function(a){if(!a)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var b=this.buffer.getContext("2d");b.clearRect(0,0,this.buffer.width,this.buffer.height);var c=a.src.split("."),d=c[1];("png"==d||"jpg"==d)&&(this.fileType=d),this.srcImage=a,this.updateClampBounds();var e=this.srcImage.height/this.srcImage.width,f=this.getBounds(),g=f.getHeight()/f.getWidth(),h=this.canvas.width,i=this.canvas.height,j=this.canvas.width/2,k=this.canvas.height/2,l=new Point(j-f.getWidth()/2,k+f.getHeight()/2),m=new Point(j+f.getWidth()/2,k+f.getHeight()/2),n=new Point(j-f.getWidth()/2,k-f.getHeight()/2),o=new Point(j+f.getWidth()/2,k-f.getHeight()/2);if(this.tl.setPosition(l.x,l.y),this.tr.setPosition(m.x,m.y),this.bl.setPosition(n.x,n.y),this.br.setPosition(o.x,o.y),this.center.setPosition(j,k),g>e){var p=Math.min(h*e,i);if(f.getHeight()>p){var q=p/g,l=new Point(j-q/2,k+p/2),m=new Point(j+q/2,k+p/2),n=new Point(j-q/2,k-p/2),o=new Point(j+q/2,k-p/2);this.tl.setPosition(l.x,l.y),this.tr.setPosition(m.x,m.y),this.bl.setPosition(n.x,n.y),this.br.setPosition(o.x,o.y)}}else if(e>g){var r=Math.min(i/e,h);if(f.getWidth()>r){var s=r*g,l=new Point(j-r/2,k+s/2),m=new Point(j+r/2,k+s/2),n=new Point(j-r/2,k-s/2),o=new Point(j+r/2,k-s/2);this.tl.setPosition(l.x,l.y),this.tr.setPosition(m.x,m.y),this.bl.setPosition(n.x,n.y),this.br.setPosition(o.x,o.y)}}this.draw(this.ctx)},a.prototype.getCroppedImage=function(a,b){var c=this.getBounds();if(!this.srcImage)throw"Source image not set.";if(a&&b){var d=this.srcImage.height/this.srcImage.width,e=this.canvas.height/this.canvas.width,f=this.canvas.width,g=this.canvas.height;e>d?(f=this.canvas.width,g=this.canvas.width*d):d>e?(g=this.canvas.height,f=this.canvas.height/d):(g=this.canvas.height,f=this.canvas.width),this.ratioW=f/this.srcImage.width,this.ratioH=g/this.srcImage.height,this.cropCanvas.width=a,this.cropCanvas.height=b;var h=(this.buffer.height-g)/2/this.ratioH,i=(this.buffer.width-f)/2/this.ratioW,j=1,k=1;this.ratioW<1&&(j=this.ratioW),this.ratioH<1&&(k=this.ratioH),this.cropCanvas.getContext("2d").drawImage(this.srcImage,Math.max(Math.round(c.left/this.ratioW-i),0),Math.max(Math.round(c.top/this.ratioH-h),0),Math.max(Math.round(c.getWidth()/j),1),Math.max(Math.round(c.getHeight()/k),1),0,0,a,b),this.croppedImage.width=a,this.croppedImage.height=b}else this.cropCanvas.width=Math.max(c.getWidth(),1),this.cropCanvas.height=Math.max(c.getHeight(),1),this.cropCanvas.getContext("2d").drawImage(this.buffer,c.left,c.top,Math.max(c.getWidth(),1),Math.max(c.getHeight(),1),0,0,c.getWidth(),c.getHeight()),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height;return this.croppedImage.src=this.cropCanvas.toDataURL("image/"+this.fileType),this.croppedImage},a.prototype.getBounds=function(){for(var a=Number.MAX_VALUE,b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d=-Number.MAX_VALUE,e=0;e<this.markers.length;e++){var f=this.markers[e];f.getPosition().x<a&&(a=f.getPosition().x),f.getPosition().x>c&&(c=f.getPosition().x),f.getPosition().y<b&&(b=f.getPosition().y),f.getPosition().y>d&&(d=f.getPosition().y)}var g=new Bounds;return g.left=a,g.right=c,g.top=b,g.bottom=d,g},a.prototype.getMousePos=function(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top}},a.prototype.onMouseMove=function(a){var b=this.getMousePos(this.canvas,a),c=!1;this.handle==this.center&&(this.canvas.style.cursor="move",c=!0),null!=this.handle&&this.handle instanceof CornerMarker&&(this.drawCornerCursor(this.handle,b.x,b.y,a),c=!0);var d=!1;if(!c){for(var e=0;e<this.markers.length;e++)d=d||this.drawCornerCursor(this.markers[e],b.x,b.y,a);if(!d){var f=a.target;f.style.cursor="initial"}}d||c||!this.center.touchInBounds(b.x,b.y)?this.center.setOver(!1):(this.center.setOver(!0),this.canvas.style.cursor="move"),this.draw(this.ctx),this.isMouseDown&&this.handleMove(b.x,b.y)},a.prototype.drawCornerCursor=function(a,b,c,d){var e;return a.touchInBounds(b,c)?(a.setOver(!0),a.getHorizontalNeighbour().getPosition().x>a.getPosition().x?a.getVerticalNeighbour().getPosition().y>a.getPosition().y?(e=d.target,e.style.cursor="nwse-resize"):(e=d.target,e.style.cursor="nesw-resize"):a.getVerticalNeighbour().getPosition().y>a.getPosition().y?(e=d.target,e.style.cursor="nesw-resize"):(e=d.target,e.style.cursor="nwse-resize"),!0):(a.setOver(!1),!1)},a.prototype.onMouseDown=function(){this.isMouseDown=!0},a.prototype.onMouseUp=function(){this.isMouseDown=!1,this.handleRelease()},a}();