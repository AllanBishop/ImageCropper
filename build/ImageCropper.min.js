var __extends=this.__extends||function(t,i){function e(){this.constructor=t}for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s]);e.prototype=i.prototype,t.prototype=new e},Handle=function(){function t(t,i,e){this.over=!1,this.drag=!1,this.position=new Point(t,i),this.offset=new Point(0,0),this.radius=e}return t.prototype.setDrag=function(t){this.drag=t,this.over=t},t.prototype.draw=function(){},t.prototype.setOver=function(t){this.over=t},t.prototype.touchInBounds=function(t,i){return t>this.position.x-this.radius&&t<this.position.x+this.radius&&i>this.position.y-this.radius&&i<this.position.y+this.radius},t.prototype.getPosition=function(){return this.position},t.prototype.setPosition=function(t,i){this.position=new Point(t,i)},t}(),CropService=function(){function t(){}return t.init=function(t){this.canvas=t,this.ctx=this.canvas.getContext("2d")},t.DEG2RAD=.0174532925,t}(),DragMarker=function(t){function i(i,e,s){t.call(this,i,e,s)}return __extends(i,t),i.prototype.draw=function(t){var i=1;(this.over||this.drag)&&(i=1.2),this.drawConnector(t,90,i),this.drawConnector(t,0,i),this.drawArrow(t,0,i),this.drawArrow(t,90,i),this.drawArrow(t,180,i),this.drawArrow(t,270,i)},i.prototype.rotatePoint=function(t,i,e,s){var o=Math.sin(e),h=Math.cos(e);s.x-=t,s.y-=i;var n=s.x*h-s.y*o,a=s.x*o+s.y*h;return s.x=n+t,s.y=a+i,s},i.prototype.drawConnector=function(t,i,e){i*=CropService.DEG2RAD;var s=new Point(this.position.x,this.position.y),o=this.rotatePoint(s.x,s.y,i,new Point(this.position.x-2*e,this.position.y+9*e)),h=this.rotatePoint(s.x,s.y,i,new Point(this.position.x+2*e,this.position.y+9*e)),n=this.rotatePoint(s.x,s.y,i,new Point(this.position.x+2*e,this.position.y-9*e)),a=this.rotatePoint(s.x,s.y,i,new Point(this.position.x-2*e,this.position.y-9*e));t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(o.x,o.y),t.lineTo(h.x,h.y),t.lineTo(n.x,n.y),t.lineTo(a.x,a.y),t.closePath(),t.fillStyle="rgba(255,228,0,1)",t.fill()},i.prototype.drawArrow=function(t,i,e){i*=CropService.DEG2RAD;var s=new Point(this.position.x,this.position.y),o=this.rotatePoint(s.x,s.y,i,new Point(this.position.x-5*e,this.position.y+8*e)),h=this.rotatePoint(s.x,s.y,i,new Point(this.position.x,this.position.y+15*e)),n=this.rotatePoint(s.x,s.y,i,new Point(this.position.x+5*e,this.position.y+8*e)),a=this.rotatePoint(s.x,s.y,i,new Point(this.position.x,this.position.y+8*e));t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(o.x,o.y),t.lineTo(h.x,h.y),t.lineTo(n.x,n.y),t.lineTo(a.x,a.y),t.closePath(),t.fillStyle="rgba(255,228,0,1)",t.fill()},i.prototype.recalculatePosition=function(t){var i=t.getCentre();this.setPosition(i.x,i.y)},i}(Handle),CornerMarker=function(t){function i(i,e,s){t.call(this,i,e,s)}return __extends(i,t),i.prototype.drawCornerBorder=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,s=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(s=-1),t.beginPath(),t.lineJoin="miter",t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*s),t.lineTo(this.position.x,this.position.y+i*s),t.lineTo(this.position.x,this.position.y),t.closePath(),t.lineWidth=2,t.strokeStyle="rgba(255,228,0,1)",t.stroke()},i.prototype.drawCornerFill=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,s=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(s=-1),t.beginPath(),t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*s),t.lineTo(this.position.x,this.position.y+i*s),t.lineTo(this.position.x,this.position.y),t.closePath(),t.fillStyle="rgba(0,0,0,1)",t.fill()},i.prototype.moveX=function(t){this.setPosition(t,this.position.y)},i.prototype.moveY=function(t){this.setPosition(this.position.x,t)},i.prototype.move=function(t,i){this.setPosition(t,i),this.verticalNeighbour.moveX(t),this.horizontalNeighbour.moveY(i)},i.prototype.addHorizontalNeighbour=function(t){this.horizontalNeighbour=t},i.prototype.addVerticalNeighbour=function(t){this.verticalNeighbour=t},i.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},i.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},i.prototype.draw=function(t){this.drawCornerFill(t),this.drawCornerBorder(t)},i}(Handle),Bounds=function(){function t(t,i,e,s){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===s&&(s=0),this.left=t,this.right=t+e,this.top=i,this.bottom=i+s}return t.prototype.getWidth=function(){return this.right-this.left},t.prototype.getHeight=function(){return this.bottom-this.top},t.prototype.getCentre=function(){var t=this.getWidth(),i=this.getHeight();return new Point(this.left+t/2,this.top+i/2)},t}(),Point=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}return t}(),ImageCropper=function(){function t(t,i,e,s,o,h,n){void 0===i&&(i=0),void 0===e&&(e=0),void 0===s&&(s=100),void 0===o&&(o=50),void 0===h&&(h=!0),void 0===n&&(n=20),this.keepAspect=!1,this.aspectRatio=0,this.handle=null,this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="png",this.imageSet=!1,CropService.init(t),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.buffer.width=t.width,this.buffer.height=t.height,this.tl=new CornerMarker(i,e,n),this.tr=new CornerMarker(i+s,e,n),this.bl=new CornerMarker(i,e+o,n),this.br=new CornerMarker(i+s,e+o,n),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new DragMarker(i+s/2,e+o/2,n),this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.keepAspect=h,this.aspectRatio=o/s,this.draw(this.ctx),this.croppedImage=new Image,window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("mousedown",this.onMouseDown.bind(this))}return t.prototype.resizeCanvas=function(t,i){this.canvas.width=t,this.canvas.height=i,this.buffer.width=t,this.buffer.height=i,this.draw(this.ctx)},t.prototype.draw=function(t){var i=this.getBounds();if(this.srcImage){t.clearRect(0,0,this.canvas.width,this.canvas.height);var e=this.srcImage.height/this.srcImage.width,s=this.canvas.height/this.canvas.width,o=this.canvas.width,h=this.canvas.height;s>e?(o=this.canvas.width,h=this.canvas.width*e):(h=this.canvas.height,o=this.canvas.height/e),this.ratioW=o/this.srcImage.width,this.ratioH=h/this.srcImage.height,e>s?t.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-o/2,0,o,h):t.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-h/2,o,h),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height),t.clearRect(0,0,this.canvas.width,this.canvas.height),e>s?t.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-o/2,0,o,h):t.drawImage(this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-h/2,o,h),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.buffer,i.left,i.top,Math.max(i.getWidth(),1),Math.max(i.getHeight(),1),i.left,i.top,i.getWidth(),i.getHeight());for(var n=0;n<this.markers.length;n++){var a=this.markers[n];a.draw(t)}this.center.draw(t),t.lineWidth=2,t.strokeStyle="rgba(255,228,0,1)",t.strokeRect(i.left,i.top,i.getWidth(),i.getHeight())}else t.fillStyle="rgba(192,192,192,1)",t.fillRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.dragCrop=function(t,i,e){var s=this.getBounds(),o=t-s.getWidth()/2,h=t+s.getWidth()/2,n=i-s.getHeight()/2,a=i+s.getHeight()/2;h>=this.maxXClamp&&(t=this.maxXClamp-s.getWidth()/2),o<=this.minXClamp&&(t=s.getWidth()/2+this.minXClamp),n<this.minYClamp&&(i=s.getHeight()/2+this.minYClamp),a>=this.maxYClamp&&(i=this.maxYClamp-s.getHeight()/2),this.tl.moveX(t-s.getWidth()/2),this.tl.moveY(i-s.getHeight()/2),this.tr.moveX(t+s.getWidth()/2),this.tr.moveY(i-s.getHeight()/2),this.bl.moveX(t-s.getWidth()/2),this.bl.moveY(i+s.getHeight()/2),this.br.moveX(t+s.getWidth()/2),this.br.moveY(i+s.getHeight()/2),e.setPosition(t,i)},t.prototype.dragCorner=function(t,i,e){if(this.keepAspect){var s=e.getHorizontalNeighbour().getVerticalNeighbour(),o=s.getPosition().x,h=s.getPosition().y;if(t<=s.getPosition().x)if(i<=s.getPosition().y){var n=o-100/this.aspectRatio,a=h-100/this.aspectRatio*this.aspectRatio,r=this.getSide(new Point(n,a),s.getPosition(),new Point(t,i));if(r>0){var g=Math.abs(s.getPosition().y-i),c=g/this.aspectRatio,p=s.getPosition().y-g,d=s.getPosition().x-c;e.move(d,p)}else if(0>r){var c=Math.abs(s.getPosition().x-t),g=c*this.aspectRatio,p=s.getPosition().y-g,d=s.getPosition().x-c;e.move(d,p)}}else{var n=o-100/this.aspectRatio,a=h+100/this.aspectRatio*this.aspectRatio,r=this.getSide(new Point(n,a),s.getPosition(),new Point(t,i));if(r>0){var c=Math.abs(s.getPosition().x-t),g=c*this.aspectRatio,p=s.getPosition().y+g,d=s.getPosition().x-c;e.move(d,p)}else if(0>r){var g=Math.abs(s.getPosition().y-i),c=g/this.aspectRatio,p=s.getPosition().y+g,d=s.getPosition().x-c;e.move(d,p)}}else if(i<=s.getPosition().y){var n=o+100/this.aspectRatio,a=h-100/this.aspectRatio*this.aspectRatio,r=this.getSide(new Point(n,a),s.getPosition(),new Point(t,i));if(0>r){var g=Math.abs(s.getPosition().y-i),c=g/this.aspectRatio,p=s.getPosition().y-g,d=s.getPosition().x+c;e.move(d,p)}else if(r>0){var c=Math.abs(s.getPosition().x-t),g=c*this.aspectRatio,p=s.getPosition().y-g,d=s.getPosition().x+c;e.move(d,p)}}else{var n=o+100/this.aspectRatio,a=h+100/this.aspectRatio*this.aspectRatio,r=this.getSide(new Point(n,a),s.getPosition(),new Point(t,i));if(0>r){var c=Math.abs(s.getPosition().x-t),g=c*this.aspectRatio,p=s.getPosition().y+g,d=s.getPosition().x+c;e.move(d,p)}else if(r>0){var g=Math.abs(s.getPosition().y-i),c=g/this.aspectRatio,p=s.getPosition().y+g,d=s.getPosition().x+c;e.move(d,p)}}}else e.move(t,i);this.center.recalculatePosition(this.getBounds())},t.prototype.getSide=function(t,i,e){return this.sign((i.x-t.x)*(e.y-t.y)-(i.y-t.y)*(e.x-t.x))},t.prototype.sign=function(t){return+t===t?0===t?t:t>0?1:-1:0/0},t.prototype.handleRelease=function(){this.handle&&this.handle.setDrag(!1),this.handle=null},t.prototype.handleMove=function(t,i){if(null!=this.handle){var e=this.clampPosition(t-this.handle.offset.x,i-this.handle.offset.y);t=e.x,i=e.y,this.handle instanceof CornerMarker?this.dragCorner(t,i,this.handle):this.dragCrop(t,i,this.handle)}else{for(var s=0;s<this.markers.length;s++){var o=this.markers[s];if(o.touchInBounds(t,i)){this.handle=o,o.setDrag(!0),this.handle.offset.x=t-this.handle.position.x,this.handle.offset.y=i-this.handle.position.y,this.dragCorner(t-this.handle.offset.x,i-this.handle.offset.y,this.handle);break}}null==this.handle&&this.center.touchInBounds(t,i)&&(this.handle=this.center,this.handle.setDrag(!0),this.handle.offset.x=t-this.handle.position.x,this.handle.offset.y=i-this.handle.position.y,this.dragCrop(t-this.handle.offset.x,i-this.handle.offset.y,this.center))}},t.prototype.updateClampBounds=function(){var t=this.srcImage.height/this.srcImage.width,i=this.canvas.height/this.canvas.width,e=this.canvas.width,s=this.canvas.height;i>t?(e=this.canvas.width,s=this.canvas.width*t):(s=this.canvas.height,e=this.canvas.height/t),this.minXClamp=this.canvas.width/2-e/2,this.minYClamp=this.canvas.height/2-s/2,this.maxXClamp=this.canvas.width/2+e/2,this.maxYClamp=this.canvas.height/2+s/2},t.prototype.clampPosition=function(t,i){return t<this.minXClamp&&(t=this.minXClamp),t>this.maxXClamp&&(t=this.maxXClamp),i<this.minYClamp&&(i=this.minYClamp),i>this.maxYClamp&&(i=this.maxYClamp),new Point(t,i)},t.prototype.isImageSet=function(){return this.imageSet},t.prototype.setImage=function(t){if(!t)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var i=this.buffer.getContext("2d");i.clearRect(0,0,this.buffer.width,this.buffer.height);var e=t.src.split("."),s=e[1];("png"==s||"jpg"==s)&&(this.fileType=s),this.srcImage=t,this.updateClampBounds();var o=this.srcImage.height/this.srcImage.width,h=this.getBounds(),n=h.getHeight()/h.getWidth(),a=this.canvas.width,r=this.canvas.height,g=this.canvas.width/2,c=this.canvas.height/2,p=new Point(g-h.getWidth()/2,c+h.getHeight()/2),d=new Point(g+h.getWidth()/2,c+h.getHeight()/2),l=new Point(g-h.getWidth()/2,c-h.getHeight()/2),u=new Point(g+h.getWidth()/2,c-h.getHeight()/2);if(this.tl.setPosition(p.x,p.y),this.tr.setPosition(d.x,d.y),this.bl.setPosition(l.x,l.y),this.br.setPosition(u.x,u.y),this.center.setPosition(g,c),n>o){var v=Math.min(a*o,r);if(h.getHeight()>v){var f=v/n,p=new Point(g-f/2,c+v/2),d=new Point(g+f/2,c+v/2),l=new Point(g-f/2,c-v/2),u=new Point(g+f/2,c-v/2);this.tl.setPosition(p.x,p.y),this.tr.setPosition(d.x,d.y),this.bl.setPosition(l.x,l.y),this.br.setPosition(u.x,u.y)}}else if(o>n){var y=Math.min(r/o,a);if(h.getWidth()>y){var m=y*n,p=new Point(g-y/2,c+m/2),d=new Point(g+y/2,c+m/2),l=new Point(g-y/2,c-m/2),u=new Point(g+y/2,c-m/2);this.tl.setPosition(p.x,p.y),this.tr.setPosition(d.x,d.y),this.bl.setPosition(l.x,l.y),this.br.setPosition(u.x,u.y)}}this.draw(this.ctx)},t.prototype.getCroppedImage=function(t,i){var e=this.getBounds();if(!this.srcImage)throw"Source image not set.";if(t&&i){var s=this.srcImage.height/this.srcImage.width,o=this.canvas.height/this.canvas.width,h=this.canvas.width,n=this.canvas.height;o>s?(h=this.canvas.width,n=this.canvas.width*s):s>o?(n=this.canvas.height,h=this.canvas.height/s):(n=this.canvas.height,h=this.canvas.width),this.ratioW=h/this.srcImage.width,this.ratioH=n/this.srcImage.height,this.cropCanvas.width=t,this.cropCanvas.height=i;var a=(this.buffer.height-n)/2/this.ratioH,r=(this.buffer.width-h)/2/this.ratioW,g=1,c=1;this.ratioW<1&&(g=this.ratioW),this.ratioH<1&&(c=this.ratioH),this.cropCanvas.getContext("2d").drawImage(this.srcImage,Math.max(e.left/this.ratioW-r,0),Math.max(e.top/this.ratioH-a,0),Math.max(e.getWidth()/g,1),Math.max(e.getHeight()/c,1),0,0,t,i),this.croppedImage.width=t,this.croppedImage.height=i}else this.cropCanvas.width=Math.max(e.getWidth(),1),this.cropCanvas.height=Math.max(e.getHeight(),1),this.cropCanvas.getContext("2d").drawImage(this.buffer,e.left,e.top,Math.max(e.getWidth(),1),Math.max(e.getHeight(),1),0,0,e.getWidth(),e.getHeight()),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height;return this.croppedImage.src=this.cropCanvas.toDataURL("image/"+this.fileType),this.croppedImage},t.prototype.getBounds=function(){for(var t=Number.MAX_VALUE,i=Number.MAX_VALUE,e=-Number.MAX_VALUE,s=-Number.MAX_VALUE,o=0;o<this.markers.length;o++){var h=this.markers[o];h.getPosition().x<t&&(t=h.getPosition().x),h.getPosition().x>e&&(e=h.getPosition().x),h.getPosition().y<i&&(i=h.getPosition().y),h.getPosition().y>s&&(s=h.getPosition().y)}var n=new Bounds;return n.left=t,n.right=e,n.top=i,n.bottom=s,n},t.prototype.getMousePos=function(t,i){var e=t.getBoundingClientRect();return{x:i.clientX-e.left,y:i.clientY-e.top}},t.prototype.onMouseMove=function(t){var i=this.getMousePos(this.canvas,t),e=!1;if(this.handle==this.center){var s=t.target;s.style.cursor="move",e=!0}null!=this.handle&&this.handle instanceof CornerMarker&&(this.drawCornerCursor(this.handle,i.x,i.y,t),e=!0);var o=!1;if(!e){for(var h=0;h<this.markers.length;h++)o=o||this.drawCornerCursor(this.markers[h],i.x,i.y,t);if(!o){var s=t.target;s.style.cursor="initial"}}if(o||e||!this.center.touchInBounds(i.x,i.y))this.center.setOver(!1);else{this.center.setOver(!0);var s=t.target;s.style.cursor="move"}this.draw(this.ctx),this.isMouseDown&&this.handleMove(i.x,i.y)},t.prototype.drawCornerCursor=function(t,i,e,s){if(t.touchInBounds(i,e)){if(t.setOver(!0),t.getHorizontalNeighbour().getPosition().x>t.getPosition().x)if(t.getVerticalNeighbour().getPosition().y>t.getPosition().y){var o=s.target;o.style.cursor="nwse-resize"}else{var o=s.target;o.style.cursor="nesw-resize"}else if(t.getVerticalNeighbour().getPosition().y>t.getPosition().y){var o=s.target;o.style.cursor="nesw-resize"}else{var o=s.target;o.style.cursor="nwse-resize"}return!0}return t.setOver(!1),!1},t.prototype.onMouseDown=function(){this.isMouseDown=!0},t.prototype.onMouseUp=function(){this.isMouseDown=!1,this.handleRelease()},t}();